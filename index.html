<!DOCTYPE html>
<html lang="ko">
  <head>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>포켓몬 검색기</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Jua&display=swap");

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Jua", sans-serif;
        background: linear-gradient(135deg, #e2e7ff, #b5c4ff);
        color: #333;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 2rem;
        min-height: 100vh;
      }

      h1 {
        color: #5d45fd;
        font-size: 2rem;
        margin-top: 2rem;
        margin-bottom: 1rem;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
      }

      /* 검색창 스타일 */
      #search-form {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 2rem;
      }

      #search-form input {
        padding: 0.6rem 1rem;
        font-size: 1rem;
        border: 2px solid #5d45fd;
        border-radius: 8px;
        outline: none;
        transition: 0.2s;
      }

      #search-form input:focus {
        border-color: #5d45fd;
      }

      #search-form button {
        padding: 0.6rem 1.2rem;
        font-size: 1rem;
        background-color: #5d45fd;
        border: none;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        transition: 0.2s;
      }

      #search-form button:hover {
        background-color: #9c8dff;
      }

      #poke-card {
        display: flex;
      }

      /* 포켓몬 카드 */
      #poke-info {
        background-color: white;
        padding: 1.5rem;
        border-radius: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        align-items: left;
        gap: 0.2rem;
        max-width: 300px;
        margin-top: 1rem;
        margin-right: 1rem;
        text-align: left;
        transition: 0.3s;
      }

      #poke-card img {
        width: 250px;
        height: 250px;
        image-rendering: pixelated;
        margin-top: 2.5rem;
        margin-right: 2rem;
      }

      #poke-card.hide {
        display: none;
      }

      #poke-card strong {
        color: #5d45fd;
      }

      #poke-extra div {
        margin-bottom: 6px;
      }

      /* 에러 메시지 */
      #message {
        margin-top: 1rem;
        padding: 0.6rem 1rem;
        background-color: #ffe5e5;
        border: 1px solid #5d45fd;
        border-radius: 8px;
        color: #5d45fd;
        font-size: 0.9rem;
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>포켓몬 검색기</h1>
    <form id="search-form">
      <input
        type="text"
        id="poke-name"
        placeholder="포켓몬 이름을 입력하세요"
      />
      <button type="submit">검색</button>
    </form>

    <div id="poke-card" class="hide">
      <img id="poke-img" src="" alt="포켓몬 이미지" />
      <div id="poke-info">
        <div>
          <strong>한글 이름</strong> : <span id="poke-koname">포켓몬</span>
        </div>
        <div>
          <strong>영어 이름</strong> : <span id="poke-enname">Pokemon</span>
        </div>

        <!-- 추가된 정보 영역 -->
        <div><strong>타입</strong> : <span id="poke-types">-</span></div>
        <div><strong>능력치</strong> :</div>
        <ul id="poke-stats"></ul>
        <div><strong>키</strong> : <span id="poke-height">-</span>cm</div>
        <div><strong>몸무게</strong> : <span id="poke-weight">-</span>kg</div>
      </div>
    </div>

    <div id="message"></div>

    <script>
      const API_BASE = "https://pokeapi.co/api/v2";
      const searchForm = document.querySelector("#search-form");
      const pokeCard = document.querySelector("#poke-card");
      const messageBox = document.querySelector("#message");

      const pokeImg = document.querySelector("#poke-img");
      const pokeKoName = document.querySelector("#poke-koname");
      const pokeEnName = document.querySelector("#poke-enname");

      // 추가된 DOM 요소들
      const pokeTypes = document.querySelector("#poke-types");
      const pokeStats = document.querySelector("#poke-stats");
      const pokeHeight = document.querySelector("#poke-height");
      const pokeWeight = document.querySelector("#poke-weight");

      let nameToIdCache = JSON.parse(localStorage.getItem("nameToId")) || {};

      // 포켓몬 한글명과 ID 매핑 가져오기
      async function getPokeId(name) {
        if (nameToIdCache[name]) return nameToIdCache[name];

        const pokeLength = 1025;
        const nameToId = {};

        const fetchKoName = async (id) => {
          const res = await fetch(`${API_BASE}/pokemon-species/${id}`);
          if (!res.ok) return;
          const data = await res.json();
          const koName = data.names.find((n) => n.language.name === "ko")?.name;
          if (koName) nameToId[koName] = id;
        };

        const promises = Array.from({ length: pokeLength }, (_, i) =>
          fetchKoName(i + 1)
        );
        await Promise.all(promises);

        nameToIdCache = nameToId;
        localStorage.setItem("nameToId", JSON.stringify(nameToId));

        return nameToId[name];
      }

      // 포켓몬 데이터 가져오기
      async function getPokemon(name) {
        try {
          messageBox.style.display = "none";
          const pokeId = await getPokeId(name);

          if (!pokeId) throw new Error("존재하지 않는 포켓몬!");

          const res = await fetch(`${API_BASE}/pokemon/${pokeId}`);
          if (!res.ok) throw new Error("포켓몬 데이터를 가져올 수 없습니다.");

          const data = await res.json();
          const koRes = await fetch(`${API_BASE}/pokemon-species/${pokeId}`);
          const koData = await koRes.json();

          const koName =
            koData.names.find((n) => n.language.name === "ko")?.name || name;

          // DOM 업데이트
          pokeImg.src = data.sprites.front_default;
          pokeKoName.textContent = koName;
          pokeEnName.textContent = data.name;

          // 타입 정보 추가
          pokeTypes.textContent = data.types.map((t) => t.type.name).join(", ");

          // 능력치 추가
          pokeStats.innerHTML = "";
          data.stats.forEach((stat) => {
            const li = document.createElement("li");
            li.textContent = `${stat.stat.name}: ${stat.base_stat}`;
            pokeStats.appendChild(li);
          });

          // 키(cm), 몸무게(kg) 단위 변환
          pokeHeight.textContent = (data.height * 10).toFixed(1);
          pokeWeight.textContent = (data.weight / 10).toFixed(1);

          pokeCard.classList.remove("hide");
          localStorage.setItem("memory", name);
        } catch (err) {
          pokeCard.classList.add("hide");
          messageBox.textContent = err.message;
          messageBox.style.display = "block";
        }
      }

      // 폼 이벤트
      searchForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const name = document.querySelector("#poke-name").value.trim();
        if (!name) {
          messageBox.textContent = "포켓몬 이름을 입력하세요!";
          messageBox.style.display = "block";
          return;
        }
        getPokemon(name);
      });

      // 초기 로드 시 마지막 검색어 표시
      document.addEventListener("DOMContentLoaded", () => {
        const memory = localStorage.getItem("memory");
        if (memory) {
          document.querySelector("#poke-name").value = memory;
          getPokemon(memory);
        }
      });
    </script>
  </body>
</html>
